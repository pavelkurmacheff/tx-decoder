import {BigNumber} from '@ethersproject/bignumber';
import {CustomTokensService} from '../helpers/tokens/custom-tokens.service';
import {Web3Service} from '../helpers/web3/web3.service';
import {Transaction, Web3Resources} from '../model/common.model';
import {decodeOneInchLimitOrderV2} from '../decoders/limit/1inch/one-inch-limit-order-v2-tx.decoder';

const fetch = require('node-fetch');

const nodeUrl = 'https://web3-node-private.1inch.exchange/';
const chainId = 1;

describe('OneInchLimitOrderFillTxDecoder test', () => {
    let resources: Web3Resources;

    beforeAll(async () => {
        resources = await Promise.all([
            fetch('https://tokens.1inch.io/v1.1/' + chainId).then((res) =>
                res.json()
            ),
            fetch('https://token-prices.1inch.io/v1.1/' + chainId).then((res) =>
                res.json()
            ),
        ]).then(([tokens, tokenPrices]) => {
            return {
                tokens,
                tokenPrices,
                customTokens: new CustomTokensService(
                    new Web3Service(nodeUrl),
                    chainId
                ),
            } as Web3Resources;
        });
    });

    // https://etherscan.io/tx/0xaf0d92ef658aa18343df7cf43cc5b8570f5cb6bf9c047c00bfc626bf9aaf9f15
    it('fill order', async () => {
        const tx: Transaction = {
            data: '0x655d13cd00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000061c4989edab2e99b17f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001605d9ee9862710000000000000000000000000000000000000000000000000000000000016d14e4e7130000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000408e41876cccdc0f92210600ef50372656052a380000000000000000000000003c7789f3cba7134e345a59d1a11ad77b13c7d79100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b4ad496106b7f00000000000000000000000000000000000000000000000000d3c21bcecced9b0a1f0000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044f4a215c3000000000000000000000000000000000000000000003b4ad496106b7f00000000000000000000000000000000000000000000000000d3c21bcecced9b0a1f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044296637bf000000000000000000000000000000000000000000003b4ad496106b7f00000000000000000000000000000000000000000000000000d3c21bcecced9b0a1f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e4961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d2828000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d28280000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e30000000000000000000000003c7789f3cba7134e345a59d1a11ad77b13c7d791000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b00000000000000000000000000000000000000000000000000000000621f9a9b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001146b175474e89094c44da98b954eedeac495271d0f0000000000000000000000003c7789f3cba7134e345a59d1a11ad77b13c7d791000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d2828000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000621f9a6b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000001b91db4d631b029fcb6d7801914182fffd1449227cc449732016a26483a1946449703011102542524a80acc65372bb1536eb02f5b4a4eac2740acbb42bb37256a8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000418e17ca0da2bf01a4b22fc78fd23cd3e4ba9b023a78c9b153fd838e6e883c826656ac0d0544a557f5cc283b199e095dd1dc82e4455980e337670a40f7d5e0ad9f0100000000000000000000000000000000000000000000000000000000000000',
            from: '0x425371f572e3a09ae09d6efa29799b8a86cfb3d3',
            gasLimit: BigNumber.from('0x2c137'),
            gasPrice: BigNumber.from('0x163F29F8A1'),
            to: '0x119c71d3bbac22029622cbaec24854d3d32d2828',
            value: '0',
        };
        const result = await decodeOneInchLimitOrderV2(resources, tx);

        expect(result).toBeDefined();
        expect(JSON.stringify(result)).toBe(
            JSON.stringify({
                srcToken: {
                    symbol: 'REN',
                    name: 'Republic',
                    address: '0x408e41876cccdc0f92210600ef50372656052a38',
                    decimals: 18,
                    logoURI:
                        'https://tokens.1inch.io/0x408e41876cccdc0f92210600ef50372656052a38.png',
                },
                dstToken: {
                    symbol: 'DAI',
                    name: 'Dai Stablecoin',
                    decimals: 18,
                    address: '0x6b175474e89094c44da98b954eedeac495271d0f',
                    logoURI:
                        'https://tokens.1inch.io/0x6b175474e89094c44da98b954eedeac495271d0f.png',
                    eip2612: true,
                },
                maxSrcAmount: {
                    type: 'BigNumber',
                    hex: '0x1605d9ee986271000000',
                },
                dstAmount: {type: 'BigNumber', hex: '0x061c4989edab2e99b17f'},
            })
        );
    });

    // https://etherscan.io/tx/0x1fd59909539a874db5f2f08be8b2d892f4d436114b830aa7c7ef5a7bb0784a8c

    it('fill order 2', async () => {
        const tx: Transaction = {
            data: '0x655d13cd00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000005cf90328600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b30cf3f7f91a380000000000000000000000000000000000000000000000000000000000b2d5d1d06a000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb000000000000000000000000019deab81e77fe551d3d096b54b3ef9b8b29f34cb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ba43b740000000000000000000000000000000000000000000000076959e11f514158090000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044f4a215c30000000000000000000000000000000000000000000000000000000ba43b740000000000000000000000000000000000000000000000076959e11f5141580900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044296637bf0000000000000000000000000000000000000000000000000000000ba43b740000000000000000000000000000000000000000000000076959e11f51415809000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e4961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d2828000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d28280000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e300000000000000000000000019deab81e77fe551d3d096b54b3ef9b8b29f34cb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000062fd45a200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000411fd7d52d520fae9a562e44ee2b6af9c15154e9f4796b91c18205fee3e482a09105e98b1929e66ce5ac726b74f84e0f82ce5b37a588fd6836255a90d652d2da911b00000000000000000000000000000000000000000000000000000000000000',
            from: '0x425371f572e3a09ae09d6efa29799b8a86cfb3d3',
            gasLimit: BigNumber.from('0x2c137'),
            gasPrice: BigNumber.from('0x163F29F8A1'),
            to: '0x119c71d3bbac22029622cbaec24854d3d32d2828',
            value: '0',
        };
        const result = await decodeOneInchLimitOrderV2(resources, tx);

        expect(result).toBeDefined();
        expect(JSON.stringify(result)).toBe(
            JSON.stringify({
                srcToken: {
                    symbol: 'MATIC',
                    name: 'Matic Token',
                    decimals: 18,
                    address: '0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0',
                    logoURI:
                        'https://tokens.1inch.io/0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0.png',
                },
                dstToken: {
                    symbol: 'USDT',
                    name: 'Tether USD',
                    address: '0xdac17f958d2ee523a2206206994597c13d831ec7',
                    decimals: 6,
                    logoURI:
                        'https://tokens.1inch.io/0xdac17f958d2ee523a2206206994597c13d831ec7.png',
                },
                maxSrcAmount: {
                    type: 'BigNumber',
                    hex: '0x03b30cf3f7f91a380000',
                },
                dstAmount: {type: 'BigNumber', hex: '0x05cf903286'},
            })
        );
    });

    it('cancel order', async () => {
        const tx: Transaction = {
            data: '0xb244b450000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000005ffc4d2e5000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000002b591e99afe9f32eaa6214f7b7629768c40eeb3900000000000000000000000004ff04ffc7358b8944f2429faec6c3fe26a2f1300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e8fe9b40000000000000000000000000000000000000000000000000000002bccdcef68000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044f4a215c300000000000000000000000000000000000000000000000000000000e8fe9b40000000000000000000000000000000000000000000000000000002bccdcef680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044296637bf00000000000000000000000000000000000000000000000000000000e8fe9b40000000000000000000000000000000000000000000000000000002bccdcef6800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e4961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d2828000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d28280000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e300000000000000000000000004ff04ffc7358b8944f2429faec6c3fe26a2f130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b000000000000000000000000000000000000000000000000000000006227b0d3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000004ff04ffc7358b8944f2429faec6c3fe26a2f130000000000000000000000000119c71d3bbac22029622cbaec24854d3d32d2828ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006227b0c9000000000000000000000000000000000000000000000000000000000000001bc1085a7370ed81018e7de945bde95bfe58dc804ac46f1cfd90d6cf43ae4af17e1bcaf6542a200254ed9a92566f97bbce2127dad6ec01d2e747033ba3eef4a14f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
            from: '0x425371f572e3a09ae09d6efa29799b8a86cfb3d3',
            gasLimit: BigNumber.from('0x2c137'),
            gasPrice: BigNumber.from('0x163F29F8A1'),
            to: '0x119c71d3bbac22029622cbaec24854d3d32d2828',
            value: '0',
        };
        const result = await decodeOneInchLimitOrderV2(resources, tx);

        expect(result).toBeDefined();
        expect(JSON.stringify(result)).toBe(
            JSON.stringify({
                srcToken: {
                    symbol: 'MATIC',
                    name: 'Matic Token',
                    decimals: 18,
                    address: '0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0',
                    logoURI:
                        'https://tokens.1inch.io/0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0.png',
                },
                dstToken: {
                    symbol: 'USDT',
                    name: 'Tether USD',
                    address: '0xdac17f958d2ee523a2206206994597c13d831ec7',
                    decimals: 6,
                    logoURI:
                        'https://tokens.1inch.io/0xdac17f958d2ee523a2206206994597c13d831ec7.png',
                },
                maxSrcAmount: {
                    type: 'BigNumber',
                    hex: '0x03b30cf3f7f91a380000',
                },
                dstAmount: {type: 'BigNumber', hex: '0x05cf903286'},
            })
        );
    });
});
